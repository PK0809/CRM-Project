{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto p-6 bg-gray-100 rounded shadow mt-6 mb-10">
    <h2 class="text-2xl font-bold mb-6 text-center">Create New Quotation</h2>

    {% if error %}
    <div class="bg-red-100 text-red-700 p-2 rounded mb-4">{{ error }}</div>
    {% endif %}

    {% if success %}
    <div class="bg-green-200 text-green-800 p-2 rounded mb-3">{{ success }}</div>
    {% endif %}

    <form method="POST" action="{% url 'create_quotation' %}">
        {% csrf_token %}

        <!-- Quote Details -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
                <label class="block font-semibold mb-1">Company Name</label>
                <select name="company_name" id="company_name" required class="w-full border px-3 py-2 rounded focus:ring-blue-500">
                    <option value="">-- Select Client --</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}">{{ client.company_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block font-semibold mb-1">Quote Date</label>
                <input type="date" name="quote_date" id="quote_date" readonly class="w-full border px-3 py-2 rounded bg-gray-100">
            </div>

            <div>
                <label class="block font-semibold mb-1">Lead No</label>
                <select name="lead_no" id="lead_no" class="w-full border px-3 py-2 rounded">
                    <option value="">-- Select Pending Lead --</option>
                    {% for lead in pending_leads %}
                    <option value="{{ lead.id }}">#{{ lead.id|stringformat:"04d" }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block font-semibold mb-1">Quote Validity (Days)</label>
                <input type="number" name="validity_days" required class="w-full border px-3 py-2 rounded">
            </div>

            <div class="col-span-1 sm:col-span-2 lg:col-span-1">
                <label class="block font-semibold mb-1">GST No</label>
                <input type="text" name="gst_no" readonly class="w-full border px-3 py-2 rounded bg-gray-100">
            </div>
        </div>


        <!-- Address Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
                <label class="block font-semibold">Billing Address</label>
                <textarea name="billing_address" rows="3" class="w-full border px-2 py-1 rounded"></textarea>
            </div>
            <div>
                <label class="block font-semibold">Shipping Address</label>
                <textarea name="shipping_address" rows="3" class="w-full border px-2 py-1 rounded"></textarea>
            </div>
        </div>

        <!-- Items Table -->
        <div class="mt-6 bg-white p-4 rounded shadow">
            <h2 class="text-xl font-bold mb-4">Items</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left border" id="itemsTable">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-2 py-2 border">Item Details</th>
                            <th class="px-2 py-2 border w-20">Qty</th>
                            <th class="px-2 py-2 border w-24">Rate</th>
                            <th class="px-2 py-2 border w-24">Tax (%)</th>
                            <th class="px-2 py-2 border w-28">Amount</th>
                            <th class="px-2 py-2 border w-12 text-center">✖</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <tr class="item-row">
                            <td class="border px-2 py-1"><input type="text" name="item_details[]" class="w-full border rounded px-2 py-1"></td>
                            <td class="border px-2 py-1"><input type="number" name="quantity[]" min="0" class="w-full border rounded px-2 py-1" oninput="calculateTotal()"></td>
                            <td class="border px-2 py-1"><input type="number" name="rate[]" class="w-full border rounded px-2 py-1" oninput="calculateTotal()"></td>
                            <td class="border px-2 py-1">
                                <select name="tax[]" class="w-full border rounded px-2 py-1" onchange="calculateTotal()">
                                    <option value="18">18%</option>
                                    <option value="28">28%</option>
                                    <option value="12">12%</option>
                                    <option value="5">5%</option>
                                    <option value="0">0%</option>
                                </select>
                            </td>
                            <td class="border px-2 py-1"><input type="text" name="amount[]" class="w-full border rounded px-2 py-1" readonly></td>
                            <td class="border px-2 py-1 text-center">
                                <button type="button" onclick="removeRow(this)" class="text-red-600 font-bold">✖</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button type="button" class="mt-3 text-sm text-blue-700" onclick="addRow()">➕ Add Item</button>
        </div>

        <!-- Totals -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
            <div>
                <label class="block font-semibold">Sub Total (₹)</label>
                <input type="text" id="sub_total" name="sub_total" readonly class="w-full border px-2 py-1 rounded bg-gray-100">
            </div>
            <div>
                <label class="block font-semibold">Discount (₹)</label>
                <input type="number" id="discount" name="discount" class="w-full border px-2 py-1 rounded" oninput="calculateTotal()">
            </div>
            <div>
                <label class="block font-semibold">GST Breakup (₹)</label>
                <input type="text" id="gst_total" name="gst_amount" readonly class="w-full border px-2 py-1 rounded bg-gray-100">
            </div>
            <div class="md:col-span-3">
                <label class="block font-bold">Total (₹)</label>
                <input type="text" id="total" name="total" readonly class="w-full border px-2 py-1 rounded bg-gray-100 text-lg font-bold">
            </div>
        </div>

        <!-- Terms & Conditions -->
        <label for="terms_conditions">Terms & Conditions</label>
        <textarea name="terms_conditions" rows="6" class="w-full border px-3 py-2 rounded">
        {{ form.terms_conditions.value|default:terms }}
        </textarea>


        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded text-lg font-bold hover:bg-green-700">
            Submit Quotation
        </button>
    </form>
</div>

<!-- JavaScript -->
<script>
    function addRow() {
        const row = document.querySelector('#itemsBody tr').cloneNode(true);
        row.querySelectorAll('input').forEach(input => input.value = '');
        document.getElementById('itemsBody').appendChild(row);
        calculateTotal();
    }

    function removeRow(button) {
        const row = button.closest('tr');
        if (document.querySelectorAll('#itemsBody tr').length > 1) {
            row.remove();
            calculateTotal();
        }
    }

    function calculateTotal() {
        let subTotal = 0, gstTotal = 0;
        const qtys = document.getElementsByName('quantity[]');
        const rates = document.getElementsByName('rate[]');
        const taxes = document.getElementsByName('tax[]');
        const amounts = document.getElementsByName('amount[]');

        for (let i = 0; i < qtys.length; i++) {
            const qty = parseFloat(qtys[i].value) || 0;
            const rate = parseFloat(rates[i].value) || 0;
            const tax = parseFloat(taxes[i].value) || 0;
            const amount = qty * rate;
            const taxAmount = (amount * tax) / 100;
            amounts[i].value = (amount + taxAmount).toFixed(2);
            subTotal += amount;
            gstTotal += taxAmount;
        }

        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const total = subTotal + gstTotal - discount;

        document.getElementById('sub_total').value = subTotal.toFixed(2);
        document.getElementById('gst_total').value = gstTotal.toFixed(2);
        document.getElementById('total').value = total.toFixed(2);
    }

    window.onload = function () {
        document.getElementById('quote_date').value = new Date().toISOString().split('T')[0];
    };

    document.addEventListener("DOMContentLoaded", function () {
        const companySelect = document.getElementById("company_name");
        const leadSelect = document.getElementById("lead_no");
        const gstInput = document.querySelector('input[name="gst_no"]');

        companySelect.addEventListener("change", function () {
            const clientId = this.value;

            // Clear previous
            leadSelect.innerHTML = '<option value="">-- Select Pending Lead --</option>';
            gstInput.value = "";

            if (clientId) {
                // 🔁 Get Leads
                fetch(`/get-pending-leads/?client_id=${clientId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.leads.length === 0) {
                            const opt = document.createElement("option");
                            opt.text = "No Pending Leads";
                            opt.disabled = true;
                            leadSelect.appendChild(opt);
                        } else {
                            data.leads.forEach(lead => {
                                const option = document.createElement("option");
                                option.value = lead.id;
                                option.text = lead.lead_no;
                                leadSelect.appendChild(option);
                            });
                        }
                    });

                // 🔁 Get GST No
                fetch(`/get-gst-no/?client_id=${clientId}`)
                    .then(response => response.json())
                    .then(data => {
                        gstInput.value = data.gst_no || "";
                    });
            }
        });
    });
</script>

{% endblock %}
