{% extends 'base.html' %}

{% block content %}
<style>
    .report-container {
        padding: 20px;
        font-family: Arial, sans-serif;
    }

    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .report-header h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }

    .report-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
    }

        .report-filters input[type="date"] {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .report-filters button {
            padding: 6px 15px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

    .report-table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
        font-size: 13px;
    }

        .report-table th,
        .report-table td {
            padding: 10px 8px;
            border: 1px solid #ccc;
            text-align: center;
            vertical-align: middle;
            line-height: 1.4;
            white-space: nowrap;
        }

        .report-table th {
            background-color: #f7f7f7;
            font-weight: 600;
        }

    .export-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

        .export-buttons a {
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #007bff;
            color: #007bff;
            font-size: 13px;
        }

            .export-buttons a:hover {
                background-color: #007bff;
                color: white;
            }

    .status-paid {
        color: green;
        font-weight: 600;
    }

    .status-partial {
        color: orange;
        font-weight: 600;
    }

    .status-not {
        color: red;
        font-weight: 600;
    }
</style>

<div class="report-container">
    <div class="report-header">
        <h2>CRM Reports</h2>
        <div class="export-buttons">
            <a href="{% url 'export_report_excel' %}" title="Export to Excel">📊 Excel</a>
            <a href="{% url 'export_report_pdf' %}" title="Export to PDF">📄 PDF</a>
        </div>
    </div>

    <form method="get" class="report-filters">
        <label for="from_date">From:</label>
        <input type="date" name="from_date" value="{{ request.GET.from_date }}">

        <label for="to_date">To:</label>
        <input type="date" name="to_date" value="{{ request.GET.to_date }}">

        <button type="submit">Filter</button>
        <div>
            <input type="text" id="reportSearch" placeholder="🔍 Search Report..." style="
            padding: 6px 12px;
            width: 250px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        ">
        </div>
    </form>

    <table class="report-table">
        <thead>
            <tr>
                <th>Lead No</th>
                <th>Lead Date</th>
                <th>Client</th>
                <th>Requirement</th>
                <th>Estimation No</th>
                <th>Status</th>
                <th>Lost Reason</th>
                <th>Client PO Number</th>
                <th>PO Date</th>
                <th>Invoice No</th>
                <th>Amount</th>
                <th>Payment Status</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in report_data %}
            <tr>
                <td>{{ entry.lead_no }}</td>
                <td>{{ entry.lead_date }}</td>
                <td>{{ entry.client }}</td>
                <td>{{ entry.requirement }}</td>
                <td>{{ entry.estimation_no }}</td>
                <td>{{ entry.estimation_status }}</td>
                <td>{{ entry.lost_reason }}</td>
                <td>
                    {% if entry.po_attachment %}
                    <a href="{{ entry.po_attachment }}" target="_blank">{{ entry.po_number }}</a>
                    {% else %}
                    {{ entry.po_number }}
                    {% endif %}
                </td>
                <td>{{ entry.po_date }}</td>
                <td>{{ entry.invoice_no }}</td>
                <td>{{ entry.invoice_amount }}</td>
                <td>
                    <span class="{% if entry.payment_status == 'Paid' %}status-paid
                                 {% elif entry.payment_status == 'Partial Paid' %}status-partial
                                 {% else %}status-not{% endif %}">
                        {{ entry.payment_status }}
                    </span>
                </td>
            </tr>
            {% endfor %}

        </tbody>
    </table>
</div>
<script>
    document.getElementById('reportSearch').addEventListener('keyup', function () {
        const searchText = this.value.toLowerCase();
        const rows = document.querySelectorAll('.report-table tbody tr');

        rows.forEach(row => {
            const rowText = row.innerText.toLowerCase();
            row.style.display = rowText.includes(searchText) ? '' : 'none';
        });
    });
</script>
<div style="margin-top: 20px; text-align: center;">
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if request.GET.from_date %}&from_date={{ request.GET.from_date }}{% endif %}{% if request.GET.to_date %}&to_date={{ request.GET.to_date }}{% endif %}">First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.from_date %}&from_date={{ request.GET.from_date }}{% endif %}{% if request.GET.to_date %}&to_date={{ request.GET.to_date }}{% endif %}">Previous</a>
        {% endif %}

        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.from_date %}&from_date={{ request.GET.from_date }}{% endif %}{% if request.GET.to_date %}&to_date={{ request.GET.to_date }}{% endif %}">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.from_date %}&from_date={{ request.GET.from_date }}{% endif %}{% if request.GET.to_date %}&to_date={{ request.GET.to_date }}{% endif %}">Last</a>
        {% endif %}
    </div>
</div>
{% endblock %}
